<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel TV - Frota</title>

  <!-- Força atualização no GitHub Pages -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #000;
      color: #fff;
      overflow: hidden;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 30px;
      background: #111;
      border-bottom: 2px solid #222;
    }
    header img {
      height: 60px;
    }
    .titulo {
      text-align: center;
      flex: 1;
      font-size: 36px;
      font-weight: bold;
    }
    .relogio {
      text-align: right;
      font-size: 22px;
      min-width: 160px;
    }
    .container {
      display: grid;
      grid-template-rows: 1fr 1fr 1fr;
      height: calc(100vh - 90px);
      gap: 12px;
      padding: 12px;
    }
    .bloco {
      background: #111;
      border-radius: 12px;
      border: 2px solid #222;
      padding: 10px 14px;
      overflow: hidden;
    }
    .bloco h2 {
      margin: 0 0 6px;
      font-size: 22px;
      text-align: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 16px;
    }
    th, td {
      border-bottom: 1px solid #222;
      padding: 6px 8px;
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    th {
      background: #1c1c1c;
      position: sticky;
      top: 0;
    }
    .status-andamento {
      background: #2a3b00;
      color: #fff600;
      font-weight: bold;
    }
    .status-concluido {
      background: #003015;
      color: #00ff90;
      font-weight: bold;
    }
  </style>
</head>
<body>

<header>
  <img src="logo.png" alt="Logo da empresa">
  <div class="titulo">PAINEL DE OPERAÇÕES</div>
  <div class="relogio" id="relogio"></div>
</header>

<div class="container">
  <div class="bloco">
    <h2>PAINEL</h2>
    <div id="painel"></div>
  </div>

  <div class="bloco">
    <h2>AGENDA DO DIA</h2>
    <div id="agendaDia"></div>
  </div>

  <div class="bloco">
    <h2>AGENDA SERVIÇO SOCIAL</h2>
    <div id="agendaSocial"></div>
  </div>
</div>

<script>
  const SHEET_ID = "1Ch3AjQ0MDo4WuQWFDR3r8nZrHb4yQkSLOtT5_QgxT6E";

  const abas = {
    painel: "PAINEL",
    agendaDia: "AGENDA DO DIA",
    agendaSocial: "AGENDA SERVIÇO SOCIAL"
  };

  function atualizarRelogio() {
    const r = document.getElementById("relogio");
    const agora = new Date();
    r.innerHTML = agora.toLocaleDateString("pt-BR") + "<br>" +
                  agora.toLocaleTimeString("pt-BR", {
                    hour: "2-digit",
                    minute: "2-digit",
                    second: "2-digit"
                  });
  }
  setInterval(atualizarRelogio, 1000);
  atualizarRelogio();

  function url(sheet) {
    return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheet)}&nocache=${Date.now()}`;
  }

  async function carregar(sheet, divId) {
    try {
      const res = await fetch(url(sheet), {
        cache: "reload"
      });
      const txt = await res.text();

      const json = JSON.parse(
        txt.substring(txt.indexOf("{"), txt.lastIndexOf("}") + 1)
      );

      const cols = json.table.cols.map(c => c.label);
      const rows = json.table.rows.map(r =>
        (r.c || []).map(c => (c ? c.v : ""))
      );

      renderTabela(divId, cols, rows, sheet);
    } catch (e) {
      document.getElementById(divId).innerHTML = "Erro ao carregar dados";
      console.error(sheet, e);
    }
  }

  function renderTabela(divId, cols, rows) {
    const div = document.getElementById(divId);

    let html = "<table><thead><tr>";
    cols.forEach(c => html += `<th>${c}</th>`);
    html += "</tr></thead><tbody>";

    rows.forEach(r => {
      let classe = "";

      const status = (r[r.length - 1] || "").toLowerCase();
      if (status.includes("andamento")) classe = "status-andamento";
      if (status.includes("concluído") || status.includes("concluido"))
        classe = "status-concluido";

      html += `<tr class="${classe}">`;

      
           
     // helper: escape HTML
function escapeHtml(str){
  return String(str ?? "").replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// formata valores vindos do gviz para formatos amigáveis BR
function formatCell(value) {
  if (value === null || value === undefined) return "";

  // já é um Date object (pouco provável no gviz, mas seguro)
  if (value instanceof Date && !isNaN(value)) {
    return value.toLocaleDateString('pt-BR');
  }

  // se for número (por ex. timestamp), mostrar como está
  if (typeof value === 'number') return String(value);

  // se for string, tratar vários formatos
  if (typeof value === 'string') {
    const s = value.trim();

    // 1) Date(YYYY,MM,DD,HH,MM,SS...) — extrai números
    const dateMatch = s.match(/^Date\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)(?:\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+))?/);
    if (dateMatch) {
      const ano = Number(dateMatch[1]);
      const mes = Number(dateMatch[2]) + 1; // months are 0-based in Date(...)
      const dia = Number(dateMatch[3]);
      // se veio hora
      if (dateMatch[4] !== undefined) {
        const hh = String(dateMatch[4]).padStart(2,'0');
        const mm = String(dateMatch[5] ?? 0).padStart(2,'0');
        const ss = String(dateMatch[6] ?? 0).padStart(2,'0');
        return `${String(dia).padStart(2,'0')}/${String(mes).padStart(2,'0')}/${ano} ${hh}:${mm}:${ss}`;
      }
      return `${String(dia).padStart(2,'0')}/${String(mes).padStart(2,'0')}/${ano}`;
    }

    // 2) TimeOfDay(H, M, S) -> converte para HH:MM:SS
    const timeMatch = s.match(/^TimeOfDay\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/);
    if (timeMatch) {
      const hh = String(timeMatch[1]).padStart(2,'0');
      const mm = String(timeMatch[2]).padStart(2,'0');
      const ss = String(timeMatch[3]).padStart(2,'0');
      return `${hh}:${mm}:${ss}`;
    }

    // 3) ISO date yyyy-mm-dd or datetime
    const isoDateMatch = s.match(/^(\d{4})-(\d{2})-(\d{2})(?:[T\s](\d{2}):(\d{2}):?(\d{2})?)?/);
    if (isoDateMatch) {
      const ano = isoDateMatch[1];
      const mes = isoDateMatch[2];
      const dia = isoDateMatch[3];
      if (isoDateMatch[4] !== undefined) {
        const hh = String(isoDateMatch[4]).padStart(2,'0');
        const mm = String(isoDateMatch[5] ?? '00').padStart(2,'0');
        const ss = String(isoDateMatch[6] ?? '00').padStart(2,'0');
        return `${dia}/${mes}/${ano} ${hh}:${mm}:${ss}`;
      }
      return `${dia}/${mes}/${ano}`;
    }

    // 4) se for string normal, retornar como está (trim)
    return s;
  }

  // 5) caso seja objeto (por ex. gviz pode retornar objetos complexos)
  if (typeof value === 'object') {
    // tente extrair field 'v' ou 'f' se existir
    if ('v' in value) return formatCell(value.v);
    if ('f' in value) return formatCell(value.f);
    // fallback: stringify
    try { return JSON.stringify(value); } catch(e) { return String(value); }
  }

  // fallback geral
  return String(value);
}


    
 r.forEach(cellValue => {
  const valorFormatado = escapeHtml(formatCell(cellValue));
  html += `<td>${valorFormatado}</td>`;
});



    div.innerHTML = html;
  }

  function atualizarTudo() {
    carregar(abas.painel, "painel");
    carregar(abas.agendaDia, "agendaDia");
    carregar(abas.agendaSocial, "agendaSocial");
  }

  atualizarTudo();
  setInterval(atualizarTudo, 60000); // 1 minuto
</script>

</body>
</html>
